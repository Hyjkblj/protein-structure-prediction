/**
 * è›‹ç™½è´¨ç»“æ„é¢„æµ‹å·¥å…·
 * æ”¯æŒå¤šç§ç»“æ„é¢„æµ‹æœåŠ¡
 */

/**
 * ä½¿ç”¨ AlphaFold æ•°æ®åº“æœç´¢ç»“æ„
 * AlphaFold æä¾›äº†å¤§é‡é¢„æµ‹çš„è›‹ç™½è´¨ç»“æ„
 */
export async function searchAlphaFold(uniprotId) {
  try {
    // é¦–å…ˆéœ€è¦å°†åºåˆ—è½¬æ¢ä¸º UniProt ID
    // è¿™é‡Œä½¿ç”¨ç®€åŒ–çš„æ–¹å¼ï¼Œå®é™…åº”è¯¥è°ƒç”¨ UniProt API
    const response = await fetch(
      `https://alphafold.ebi.ac.uk/api/prediction/${uniprotId}`
    )
    
    if (response.ok) {
      const data = await response.json()
      return data
    }
  } catch (error) {
    console.error('AlphaFold æœç´¢å¤±è´¥:', error)
  }
  
  return null
}

/**
 * ä½¿ç”¨ AlphaFold æ•°æ®åº“æœç´¢ç»“æ„
 * AlphaFold æä¾›äº†å¤§é‡é¢„æµ‹çš„è›‹ç™½è´¨ç»“æ„
 */
export async function searchAlphaFoldBySequence(sequence) {
  try {
    // é¦–å…ˆå°è¯•é€šè¿‡ UniProt ID æœç´¢
    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥å…ˆé€šè¿‡åºåˆ—æœç´¢ UniProt
    // æš‚æ—¶è¿”å› nullï¼Œåç»­å¯ä»¥å®Œå–„
    return null
  } catch (error) {
    console.error('AlphaFold æœç´¢å¤±è´¥:', error)
  }
  return null
}

/**
 * ä½¿ç”¨ ColabFold API è¿›è¡Œç»“æ„é¢„æµ‹ï¼ˆæ›¿ä»£æ–¹æ¡ˆï¼‰
 * æ³¨æ„ï¼šè¿™éœ€è¦åç«¯ä»£ç†ï¼Œå› ä¸º CORS é™åˆ¶
 */
export async function predictWithColabFold(sequence) {
  // ColabFold ä¹Ÿéœ€è¦åç«¯æ”¯æŒ
  // æš‚æ—¶è¿”å› null
  return null
}

/**
 * ç”Ÿæˆæ¼”ç¤ºç”¨çš„ PDB ç»“æ„ï¼ˆçº¯å‰ç«¯ï¼‰
 * åˆ›å»ºä¸€ä¸ªç®€å•çš„èºæ—‹ç»“æ„ä½œä¸ºæ¼”ç¤º
 */
export function generatePlaceholderStructure(sequence) {
  // ç”Ÿæˆä¸€ä¸ªç®€å•çš„ Î±-èºæ—‹ç»“æ„ä½œä¸ºæ¼”ç¤º
  let pdbContent = 'HEADER    PROTEIN STRUCTURE DEMO\n'
  pdbContent += 'TITLE     DEMO STRUCTURE FROM SEQUENCE\n'
  pdbContent += `REMARK   1 Sequence: ${sequence}\n`
  pdbContent += `REMARK   2 Length: ${sequence.length} residues\n`
  pdbContent += 'REMARK   3 This is a demo structure for visualization\n'
  pdbContent += 'REMARK   4 Generated by frontend demo\n'
  
  let atomNum = 1
  let residueNum = 1
  
  // Î±-èºæ—‹çš„å‚æ•°
  const risePerResidue = 1.5  // Ã…
  const rotationPerResidue = 100  // åº¦
  const radius = 2.3  // Ã…
  
  // æ¯ä¸ªæ®‹åŸºçš„åŸå­åæ ‡ï¼ˆç›¸å¯¹äº CAï¼‰
  const atomOffsets = {
    'N': { x: -0.5, y: 0, z: 0 },
    'CA': { x: 0, y: 0, z: 0 },
    'C': { x: 1.5, y: 0, z: 0 },
    'O': { x: 1.5, y: 0, z: 1.2 }
  }
  
  for (let i = 0; i < sequence.length; i++) {
    const residue = sequence[i]
    const angle = (i * rotationPerResidue * Math.PI) / 180
    const z = i * risePerResidue
    const x = radius * Math.cos(angle)
    const y = radius * Math.sin(angle)
    
    // CA åŸå­ä½ç½®
    const caX = x
    const caY = y
    const caZ = z
    
    // æ·»åŠ æ¯ä¸ªåŸå­
    for (const [atomName, offset] of Object.entries(atomOffsets)) {
      const atomX = caX + offset.x
      const atomY = caY + offset.y
      const atomZ = caZ + offset.z
      
      // PDB æ ¼å¼ï¼šATOM è®°å½•æ ¼å¼
      // åˆ— 1-6: ATOM
      // åˆ— 7-11: åŸå­åºå·
      // åˆ— 13-16: åŸå­åç§°
      // åˆ— 18-20: æ®‹åŸºåç§°
      // åˆ— 22: é“¾æ ‡è¯†ç¬¦
      // åˆ— 23-26: æ®‹åŸºåºå·
      // åˆ— 31-38: Xåæ ‡
      // åˆ— 39-46: Yåæ ‡
      // åˆ— 47-54: Zåæ ‡
      const atomLine = `ATOM  ${String(atomNum).padStart(5)} ${atomName.padEnd(4)} ${residue.padEnd(3)} A${String(residueNum).padStart(4)}    ${atomX.toFixed(3).padStart(8)}${atomY.toFixed(3).padStart(8)}${atomZ.toFixed(3).padStart(8)}  1.00 20.00           ${atomName[0]}\n`
      pdbContent += atomLine
      atomNum++
    }
    
    residueNum++
  }
  
  pdbContent += 'END\n'
  
  return pdbContent
}

/**
 * åœ¨ PDB ä¸­æœç´¢åºåˆ—
 * ä½¿ç”¨æ­£ç¡®çš„ RCSB PDB Search API v2 æ ¼å¼
 */
export async function searchPdbBySequence(sequence) {
  try {
    // ä½¿ç”¨ POST è¯·æ±‚ï¼Œé¿å… URL è¿‡é•¿
    const query = {
      query: {
        type: 'terminal',
        service: 'sequence',
        parameters: {
          sequence: sequence,
          identity_cutoff: 0.9,
          evalue_cutoff: 0.001
        }
      },
      return_type: 'entry',
      request_options: {
        paginate: {
          start: 0,
          rows: 5
        },
        results_content_type: ['experimental']
      }
    }

    const response = await fetch('https://search.rcsb.org/rcsbsearch/v2/query', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(query)
    })
    
    if (response.ok) {
      const data = await response.json()
      if (data.result_set && data.result_set.length > 0) {
        return {
          pdbId: data.result_set[0].identifier,
          title: data.result_set[0].title || '',
          score: data.result_set[0].score || 0
        }
      }
    } else {
      const errorText = await response.text()
      console.warn('PDB æœç´¢ API å“åº”:', response.status, errorText)
    }
  } catch (error) {
    console.error('PDB æœç´¢å¤±è´¥:', error)
  }
  
  return null
}

/**
 * ä»åºåˆ—ç”Ÿæˆç»“æ„ï¼ˆä¸»è¦å‡½æ•°ï¼‰
 * çº¯å‰ç«¯ demoï¼šç›´æ¥ç”Ÿæˆæ¼”ç¤ºç»“æ„ï¼Œè·³è¿‡ PDB æœç´¢ï¼ˆé¿å… API é”™è¯¯ï¼‰
 */
export async function generateStructureFromSequence(sequence) {
  // å¯¹äº demoï¼Œç›´æ¥ç”Ÿæˆæ¼”ç¤ºç»“æ„ï¼Œè·³è¿‡ PDB æœç´¢
  // è¿™æ ·å¯ä»¥é¿å… API é”™è¯¯ï¼Œä¸“æ³¨äºå±•ç¤ºåŠŸèƒ½
  console.log('ğŸ“ å‰ç«¯ Demoï¼šç”Ÿæˆæ¼”ç¤ºç»“æ„ï¼ˆÎ±-èºæ—‹æ¨¡å‹ï¼‰')
  console.log(`åºåˆ—é•¿åº¦ï¼š${sequence.length} ä¸ªæ°¨åŸºé…¸`)
  
  const demoPdb = generatePlaceholderStructure(sequence)
  
  return {
    type: 'demo',
    pdbData: demoPdb,
    note: `å·²ç”Ÿæˆæ¼”ç¤ºç»“æ„ï¼ˆÎ±-èºæ—‹æ¨¡å‹ï¼‰ã€‚åºåˆ—é•¿åº¦ï¼š${sequence.length} ä¸ªæ°¨åŸºé…¸ã€‚è¿™æ˜¯ä¸€ä¸ªçº¯å‰ç«¯ demoï¼Œå±•ç¤ºä»åºåˆ—åˆ°3Dç»“æ„çš„å¯è§†åŒ–æµç¨‹ã€‚`
  }
  
  /* 
  // å¦‚æœéœ€è¦çœŸå®çš„ PDB æœç´¢ï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢çš„æ³¨é‡Š
  // æ­¥éª¤1ï¼šåœ¨ PDB ä¸­æœç´¢
  console.log('åœ¨ PDB ä¸­æœç´¢åºåˆ—...')
  try {
    const pdbResult = await searchPdbBySequence(sequence)
    
    if (pdbResult) {
      console.log('æ‰¾åˆ° PDB ç»“æ„:', pdbResult.pdbId)
      return {
        type: 'pdb',
        pdbId: pdbResult.pdbId,
        title: pdbResult.title,
        url: `https://files.rcsb.org/view/${pdbResult.pdbId}.pdb`
      }
    }
  } catch (error) {
    console.warn('PDB æœç´¢å¤±è´¥ï¼Œä½¿ç”¨æ¼”ç¤ºç»“æ„:', error)
  }
  
  // å¦‚æœæœç´¢å¤±è´¥ï¼Œç”Ÿæˆæ¼”ç¤ºç»“æ„
  const demoPdb = generatePlaceholderStructure(sequence)
  return {
    type: 'demo',
    pdbData: demoPdb,
    note: `å·²ç”Ÿæˆæ¼”ç¤ºç»“æ„ï¼ˆÎ±-èºæ—‹æ¨¡å‹ï¼‰ã€‚åºåˆ—é•¿åº¦ï¼š${sequence.length} ä¸ªæ°¨åŸºé…¸ã€‚`
  }
  */
}

